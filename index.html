<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è°¢æ—åŒºéš”æ¨¡å‹ Â· Schelling Segregation Model</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: 'Noto Sans SC', 'Microsoft YaHei', 'PingFang SC', sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  #app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }

  /* ===== Left panel ===== */
  #grid-panel {
    flex: 0 0 60%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #16213e;
    position: relative;
    padding: 16px 20px;
  }

  #grid-title {
    font-size: clamp(18px, 2.2vw, 34px);
    font-weight: 700;
    color: #e8d5b7;
    margin-bottom: 6px;
    letter-spacing: 3px;
  }

  #grid-subtitle {
    font-size: clamp(11px, 1vw, 16px);
    color: #8a8a9a;
    margin-bottom: 12px;
    letter-spacing: 1px;
  }

  #canvas-wrapper {
    border: 3px solid #2a2a4a;
    border-radius: 4px;
    box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.3);
    line-height: 0;
  }

  canvas#grid {
    display: block;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }

  #step-bar {
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 24px;
    font-size: clamp(13px, 1.1vw, 20px);
    color: #b0b0c0;
  }
  #step-bar .label { color: #7a7a9a; }
  #step-bar .value { color: #f0c040; font-weight: 700; font-variant-numeric: tabular-nums; }

  #converged-banner {
    display: none;
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(46,204,113,0.92);
    color: #1a1a2e;
    font-size: clamp(14px, 1.3vw, 22px);
    font-weight: 700;
    padding: 10px 32px;
    border-radius: 8px;
    letter-spacing: 2px;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }

  /* ===== Right panel ===== */
  #right-panel {
    flex: 0 0 40%;
    display: flex;
    flex-direction: column;
    background: linear-gradient(175deg, #1f1f3a 0%, #16213e 50%, #1a1a2e 100%);
    padding: clamp(14px, 1.6vw, 28px);
    overflow: hidden;
  }

  .card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: clamp(14px, 1.5vw, 28px);
    margin-bottom: clamp(8px, 1vw, 16px);
  }

  .card-title {
    font-size: clamp(15px, 1.4vw, 24px);
    font-weight: 700;
    color: #e8d5b7;
    margin-bottom: clamp(10px, 1vw, 18px);
    padding-bottom: 7px;
    border-bottom: 1px solid rgba(232,213,183,0.15);
    letter-spacing: 1px;
  }

  /* ===== Controls ===== */
  .control-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: clamp(4px, 0.4vw, 6px);
  }
  .control-label { font-size: clamp(13px, 1.2vw, 20px); color: #b0b0c0; }
  .control-value { font-size: clamp(15px, 1.4vw, 24px); font-weight: 700; color: #f0c040; min-width: 50px; text-align: right; font-variant-numeric: tabular-nums; }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 7px;
    border-radius: 4px;
    background: #2a2a4a;
    outline: none;
    margin: 8px 0 4px 0;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: clamp(16px, 1.5vw, 24px);
    height: clamp(16px, 1.5vw, 24px);
    border-radius: 50%;
    background: #e8d5b7;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(232,213,183,0.4);
  }
  input[type="range"]::-moz-range-thumb {
    width: clamp(16px, 1.5vw, 24px);
    height: clamp(16px, 1.5vw, 24px);
    border-radius: 50%;
    background: #e8d5b7;
    cursor: pointer;
    border: none;
  }

  .btn-row {
    display: flex;
    gap: clamp(5px, 0.5vw, 10px);
    margin-top: clamp(10px, 1vw, 18px);
  }

  .btn {
    flex: 1;
    padding: clamp(9px, 0.9vw, 16px) 0;
    border: none;
    border-radius: 8px;
    font-size: clamp(13px, 1.15vw, 19px);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .btn-start { background: #2ecc71; color: #1a1a2e; }
  .btn-start:hover { background: #27ae60; }
  .btn-start.running { background: #e67e22; }
  .btn-start.running:hover { background: #d35400; }

  .btn-reset { background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.15); }
  .btn-reset:hover { background: rgba(255,255,255,0.18); }

  .btn-step { background: rgba(100,149,237,0.25); color: #6495ed; border: 1px solid rgba(100,149,237,0.3); }
  .btn-step:hover { background: rgba(100,149,237,0.4); }

  .btn-speed { background: rgba(240,192,64,0.15); color: #f0c040; border: 1px solid rgba(240,192,64,0.3); min-width: 0; }
  .btn-speed:hover { background: rgba(240,192,64,0.3); }
  .btn-speed.active { background: rgba(240,192,64,0.35); box-shadow: 0 0 10px rgba(240,192,64,0.25); }

  /* ===== Stats ===== */
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: clamp(8px, 0.9vw, 16px);
  }
  .stat-item {
    background: rgba(255,255,255,0.03);
    border-radius: 10px;
    padding: clamp(12px, 1.2vw, 22px) clamp(8px, 0.8vw, 14px);
    text-align: center;
  }
  .stat-num { font-size: clamp(22px, 2.2vw, 40px); font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1.2; }
  .stat-label { font-size: clamp(11px, 1vw, 16px); color: #7a7a9a; margin-top: 4px; }
  .stat-steps .stat-num { color: #f0c040; }
  .stat-time .stat-num { color: #3498db; }
  .stat-unhappy .stat-num { color: #e74c3c; }
  .stat-seg .stat-num { color: #9b59b6; }

  /* Chart */
  #chart-wrapper { width: 100%; height: clamp(70px, 7vw, 130px); margin-top: 8px; }
  canvas#chart { width: 100%; height: 100%; border-radius: 6px; background: rgba(0,0,0,0.2); }

  /* ===== Legend - horizontal ===== */
  .legend-bar {
    display: flex;
    align-items: center;
    justify-content: space-around;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: clamp(6px, 0.6vw, 12px);
    font-size: clamp(13px, 1.15vw, 19px);
  }
  .legend-swatch {
    width: clamp(18px, 1.5vw, 26px);
    height: clamp(18px, 1.5vw, 26px);
    border-radius: 4px;
    flex-shrink: 0;
  }

  /* ===== Description - compact ===== */
  #desc-card {
    flex: 3;
    display: flex;
    flex-direction: column;
    margin-bottom: 0;
  }

  /* Upper cards get more flex weight */
  #ctrl-card { flex: 5; display: flex; flex-direction: column; }
  #ctrl-card .card-inner { flex: 1; display: flex; flex-direction: column; justify-content: center; }
  #stats-card { flex: 7; display: flex; flex-direction: column; }
  #stats-card .card-inner { flex: 1; display: flex; flex-direction: column; justify-content: center; }
  #legend-card { flex: 0 0 auto; }

  #desc-card .desc-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    color: #c8c8d8;
  }

  #desc-card .desc-text p {
    text-indent: 2em;
    line-height: 1.85;
  }

  .highlight { color: #f0c040; font-weight: 500; }
</style>
</head>
<body>
<div id="app">

  <!-- Left: Grid -->
  <div id="grid-panel">
    <div id="grid-title">è°¢æ—åŒºéš”æ¨¡å‹</div>
    <div id="grid-subtitle">Schelling Segregation Model Â· 200 Ã— 200</div>
    <div id="canvas-wrapper">
      <canvas id="grid"></canvas>
    </div>
    <div id="step-bar">
      <span><span class="label">è¿­ä»£ </span><span class="value" id="info-steps">0</span></span>
      <span><span class="label">æ¬è¿ </span><span class="value" id="info-moves">0</span></span>
      <span><span class="label">çŠ¶æ€ </span><span class="value" id="info-status">å°±ç»ª</span></span>
    </div>
    <div id="converged-banner">âœ“ ç³»ç»Ÿå·²æ”¶æ•›è‡³ç¨³æ€</div>
  </div>

  <!-- Right -->
  <div id="right-panel">

    <!-- Controls -->
    <div class="card" id="ctrl-card">
      <div class="card-title">âš™ ä»¿çœŸæ§åˆ¶</div>
      <div class="card-inner">
        <div class="control-row">
          <span class="control-label">åŒæ—åå¥½é˜ˆå€¼</span>
          <span class="control-value" id="val-threshold">50%</span>
        </div>
        <input type="range" id="slider-threshold" min="0" max="100" value="50">

        <div class="control-row" style="margin-top:10px;">
          <span class="control-label">ç©ºç½®ç‡</span>
          <span class="control-value" id="val-empty">10%</span>
        </div>
        <input type="range" id="slider-empty" min="5" max="40" value="10">

        <div class="btn-row">
          <button class="btn btn-start" id="btn-start" onclick="toggleRun()">â–¶ å¯åŠ¨</button>
          <button class="btn btn-step" onclick="stepOnce()">â­ å•æ­¥</button>
          <button class="btn btn-reset" onclick="resetModel()">â†» é‡ç½®</button>
          <button class="btn btn-speed" id="btn-speed" onclick="cycleSpeed()">1Ã—</button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="card" id="stats-card">
      <div class="card-title">ğŸ“Š å®æ—¶ç»Ÿè®¡</div>
      <div class="card-inner">
        <div class="stat-grid">
          <div class="stat-item stat-steps"><div class="stat-num" id="stat-steps">0</div><div class="stat-label">è¿­ä»£æ­¥æ•°</div></div>
          <div class="stat-item stat-time"><div class="stat-num" id="stat-time">00:00</div><div class="stat-label">è¿è¡Œæ—¶é—´</div></div>
          <div class="stat-item stat-unhappy"><div class="stat-num" id="stat-unhappy">0</div><div class="stat-label">ä¸æ»¡æ„ä½æˆ·</div></div>
          <div class="stat-item stat-seg"><div class="stat-num" id="stat-seg">50.0%</div><div class="stat-label">éš”ç¦»æŒ‡æ•°</div></div>
        </div>
        <div id="chart-wrapper"><canvas id="chart"></canvas></div>
      </div>
    </div>

    <!-- Legend -->
    <div class="card" id="legend-card" style="padding-top:clamp(10px,1vw,16px);padding-bottom:clamp(10px,1vw,16px);">
      <div class="legend-bar">
        <div class="legend-item"><div class="legend-swatch" style="background:#e74c3c;"></div><span>æ—ç¾¤ A</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:#2c3e50;"></div><span>æ—ç¾¤ B</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:#f5f0dc;"></div><span>ç©ºç½®</span></div>
      </div>
    </div>

    <!-- Description -->
    <div class="card" id="desc-card">
      <div class="card-title">ğŸ“– æ¨¡å‹è¯´æ˜</div>
      <div class="desc-text" id="desc-text">
        <p>Schelling Thomas C. Schelling äº 1971 å¹´æå‡ºçš„åŒºéš”æ¨¡å‹æ­ç¤ºäº†ä¸€ä¸ªæ·±åˆ»çš„ç¤¾ä¼šæ¶Œç°æœºåˆ¶ï¼š<span class="highlight">å³ä½¿ä¸ªä½“ä»…æŒæœ‰æ¸©å’Œçš„åŒè´¨æ€§åå¥½ï¼Œç¾¤ä½“å±‚é¢ä¹Ÿä¼šè‡ªå‘æ¼”åŒ–å‡ºé«˜åº¦éš”ç¦»çš„ç©ºé—´æ ¼å±€</span>ã€‚</p>
        <p>æ¯ä¸ªæ™ºèƒ½ä½“æ£€æŸ¥Mooreé‚»åŸŸä¸­åŒæ—æ¯”ä¾‹ï¼Œè‹¥ä½äºåå¥½é˜ˆå€¼åˆ™éšæœºè¿ç§»è‡³ç©ºç½®ä½ç½®ã€‚ç³»ç»ŸæŒç»­æ¼”åŒ–ç›´è‡³æ‰€æœ‰æ™ºèƒ½ä½“å‡æ»¡æ„ï¼ˆç¨³æ€æ”¶æ•›ï¼‰ã€‚é˜ˆå€¼ 30%~50% å³å¯è§‚æµ‹åˆ°æ˜¾è‘—çš„è‡ªç»„ç»‡éš”ç¦»ç°è±¡ã€‚</p>
      </div>
    </div>

  </div>
</div>

<script>
// ====== CONFIG ======
const N = 200;
const COLORS = { 0:[245,240,220], 1:[231,76,60], 2:[44,62,80] };

// ====== STATE ======
let cells = new Uint8Array(N * N);
let running = false, animId = null;
let steps = 0, totalMoves = 0, lastMoves = 0, converged = false;
let emptyList = [], unhappyHistory = [], segHistory = [];
let startTime = null, elapsedMs = 0, lastFrameTime = 0;

// Slow base: ~4 frames per iteration step at 1Ã—
const SPEED_LEVELS = [1, 5, 10, 20];
let speedIdx = 0;
let frameTick = 0;
const BASE_FRAMES_PER_STEP = 4; // 1Ã— means one step every 4 frames â‰ˆ 15 steps/sec

// ====== DOM ======
const canvas = document.getElementById('grid');
const ctx = canvas.getContext('2d');
const chartCanvas = document.getElementById('chart');
const chartCtx = chartCanvas.getContext('2d');

// ====== SIZING ======
function resize() {
  const panel = document.getElementById('grid-panel');
  const maxW = panel.clientWidth - 40;
  const maxH = panel.clientHeight - 120;
  const sz = Math.min(maxW, maxH);
  const cellPx = Math.max(2, Math.floor(sz / N));
  const canvasPx = cellPx * N;
  canvas.width = canvasPx; canvas.height = canvasPx;
  canvas.style.width = canvasPx + 'px'; canvas.style.height = canvasPx + 'px';
  canvas.cellPx = cellPx;

  const cw = chartCanvas.parentElement;
  chartCanvas.width = cw.clientWidth * (window.devicePixelRatio || 1);
  chartCanvas.height = cw.clientHeight * (window.devicePixelRatio || 1);

  adjustDescFont();
  drawGrid(); drawChart();
}

function adjustDescFont() {
  const card = document.getElementById('desc-card');
  const text = document.getElementById('desc-text');
  const titleEl = card.querySelector('.card-title');
  const cardH = card.clientHeight;
  const titleH = titleEl.offsetHeight;
  const style = getComputedStyle(card);
  const padV = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom);
  const availH = cardH - titleH - padV - 8;
  let lo = 10, hi = 36, best = 14;
  for (let iter = 0; iter < 15; iter++) {
    const mid = (lo + hi) / 2;
    text.style.fontSize = mid + 'px';
    if (text.scrollHeight <= availH) { best = mid; lo = mid + 0.5; }
    else { hi = mid - 0.5; }
  }
  text.style.fontSize = best + 'px';
}

// ====== INIT ======
function initModel() {
  const emptyRate = parseInt(document.getElementById('slider-empty').value) / 100;
  emptyList = [];
  for (let i = 0; i < N * N; i++) {
    const r = Math.random();
    if (r < emptyRate) { cells[i] = 0; emptyList.push(i); }
    else if (r < emptyRate + (1 - emptyRate) / 2) { cells[i] = 1; }
    else { cells[i] = 2; }
  }
  steps = 0; totalMoves = 0; lastMoves = 0; converged = false;
  unhappyHistory = []; segHistory = [];
  startTime = null; elapsedMs = 0; frameTick = 0;
  document.getElementById('converged-banner').style.display = 'none';
}

// ====== DRAW GRID ======
function drawGrid() {
  const px = canvas.cellPx || 2;
  const imgData = ctx.createImageData(canvas.width, canvas.height);
  const d = imgData.data;
  for (let y = 0; y < N; y++) {
    for (let x = 0; x < N; x++) {
      const c = COLORS[cells[y * N + x]];
      const sy = y * px, sx = x * px;
      for (let dy = 0; dy < px; dy++) {
        const rowOff = (sy + dy) * canvas.width;
        for (let dx = 0; dx < px; dx++) {
          const idx = (rowOff + sx + dx) * 4;
          d[idx] = c[0]; d[idx+1] = c[1]; d[idx+2] = c[2]; d[idx+3] = 255;
        }
      }
    }
  }
  ctx.putImageData(imgData, 0, 0);
}

// ====== NEIGHBORS ======
function getSameRatio(idx) {
  const type = cells[idx];
  if (type === 0) return 1;
  const x = idx % N, y = (idx - x) / N;
  let same = 0, total = 0;
  for (let dy = -1; dy <= 1; dy++) {
    for (let dx = -1; dx <= 1; dx++) {
      if (dy === 0 && dx === 0) continue;
      const nx = x + dx, ny = y + dy;
      if (nx < 0 || nx >= N || ny < 0 || ny >= N) continue;
      const n = cells[ny * N + nx];
      if (n !== 0) { total++; if (n === type) same++; }
    }
  }
  return total === 0 ? 1 : same / total;
}

// ====== STEP ======
function stepModel() {
  const threshold = parseInt(document.getElementById('slider-threshold').value) / 100;
  let unhappy = [];
  for (let i = 0; i < N * N; i++) {
    if (cells[i] !== 0 && getSameRatio(i) < threshold) unhappy.push(i);
  }
  for (let i = unhappy.length - 1; i > 0; i--) {
    const j = Math.random() * (i + 1) | 0;
    [unhappy[i], unhappy[j]] = [unhappy[j], unhappy[i]];
  }
  let moves = 0;
  for (const idx of unhappy) {
    if (emptyList.length === 0) break;
    const ei = Math.random() * emptyList.length | 0;
    const target = emptyList[ei];
    cells[target] = cells[idx]; cells[idx] = 0;
    emptyList[ei] = idx; moves++;
  }
  steps++; totalMoves += moves; lastMoves = moves;
  if (moves === 0) {
    converged = true; running = false;
    document.getElementById('converged-banner').style.display = 'block';
    updateStartBtn();
  }
}

// ====== STATS ======
function computeStats() {
  const threshold = parseInt(document.getElementById('slider-threshold').value) / 100;
  let unhappyCount = 0, agents = 0, samePairs = 0, totalPairs = 0;
  for (let i = 0; i < N * N; i++) {
    if (cells[i] === 0) continue;
    agents++;
    if (getSameRatio(i) < threshold) unhappyCount++;
    const x = i % N, y = (i - x) / N;
    for (let dy = -1; dy <= 1; dy++) {
      for (let dx = -1; dx <= 1; dx++) {
        if (dy === 0 && dx === 0) continue;
        const nx = x + dx, ny = y + dy;
        if (nx < 0 || nx >= N || ny < 0 || ny >= N) continue;
        const n = cells[ny * N + nx];
        if (n !== 0) { totalPairs++; if (n === cells[i]) samePairs++; }
      }
    }
  }
  const segIdx = totalPairs > 0 ? samePairs / totalPairs * 100 : 50;
  unhappyHistory.push(unhappyCount);
  segHistory.push(segIdx);
  if (unhappyHistory.length > 300) { unhappyHistory.shift(); segHistory.shift(); }
  return { unhappyCount, segIdx, agents };
}

function formatTime(ms) {
  const totalSec = Math.floor(ms / 1000);
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

function updateUI(stats) {
  document.getElementById('stat-steps').textContent = steps.toLocaleString();
  document.getElementById('stat-time').textContent = formatTime(elapsedMs);
  document.getElementById('stat-unhappy').textContent = stats.unhappyCount.toLocaleString();
  document.getElementById('stat-seg').textContent = stats.segIdx.toFixed(1) + '%';
  document.getElementById('info-steps').textContent = steps;
  document.getElementById('info-moves').textContent = lastMoves.toLocaleString();
  document.getElementById('info-status').textContent = converged ? 'å·²æ”¶æ•›' : (running ? 'è¿è¡Œä¸­' : 'å·²æš‚åœ');
}

// ====== CHART ======
function drawChart() {
  const c = chartCanvas, cx = chartCtx;
  const w = c.width, h = c.height;
  const dpr = window.devicePixelRatio || 1;
  cx.clearRect(0, 0, w, h);
  if (segHistory.length < 2) return;
  const pad = 4 * dpr, plotW = w - pad * 2, plotH = h - pad * 2;
  const len = segHistory.length;

  // Unhappy count line (red) - normalize to max
  const maxUnhappy = Math.max(...unhappyHistory, 1);
  cx.beginPath(); cx.strokeStyle = 'rgba(231,76,60,0.9)'; cx.lineWidth = 1.5 * dpr;
  for (let i = 0; i < len; i++) {
    const x = pad + (i / (len - 1)) * plotW;
    const y = pad + (1 - unhappyHistory[i] / maxUnhappy) * plotH;
    i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
  } cx.stroke();

  // Segregation index line (purple)
  cx.beginPath(); cx.strokeStyle = 'rgba(155,89,182,0.9)'; cx.lineWidth = 1.5 * dpr;
  for (let i = 0; i < len; i++) {
    const x = pad + (i / (len - 1)) * plotW;
    const y = pad + (1 - segHistory[i] / 100) * plotH;
    i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
  } cx.stroke();

  cx.font = `${10 * dpr}px sans-serif`;
  cx.fillStyle = 'rgba(231,76,60,0.8)'; cx.fillText('ä¸æ»¡æ„ä½æˆ·', pad, pad + 10 * dpr);
  cx.fillStyle = 'rgba(155,89,182,0.8)'; cx.fillText('éš”ç¦»æŒ‡æ•°', pad + 70 * dpr, pad + 10 * dpr);
}

// ====== SPEED ======
function cycleSpeed() {
  speedIdx = (speedIdx + 1) % SPEED_LEVELS.length;
  const btn = document.getElementById('btn-speed');
  btn.textContent = SPEED_LEVELS[speedIdx] + 'Ã—';
  btn.classList.toggle('active', speedIdx > 0);
}

// ====== RUN LOOP ======
function runLoop(ts) {
  if (!running) return;

  // Track elapsed time
  if (!startTime) startTime = ts - elapsedMs;
  elapsedMs = ts - startTime;

  // Throttle: at 1Ã— do 1 step every BASE_FRAMES_PER_STEP frames
  const speed = SPEED_LEVELS[speedIdx];
  frameTick++;

  let didStep = false;
  if (speed <= 1) {
    // 1Ã—: step once every BASE_FRAMES_PER_STEP frames
    if (frameTick % BASE_FRAMES_PER_STEP === 0) {
      stepModel();
      didStep = true;
    }
  } else {
    // Higher speeds: multiple steps per frame
    const stepsPerFrame = Math.ceil(speed / BASE_FRAMES_PER_STEP) || 1;
    for (let i = 0; i < stepsPerFrame; i++) {
      if (converged) break;
      stepModel();
      didStep = true;
    }
  }

  if (didStep) {
    drawGrid();
    const stats = computeStats();
    updateUI(stats);
    drawChart();
  }

  animId = requestAnimationFrame(runLoop);
}

// ====== CONTROLS ======
function toggleRun() {
  if (converged) return;
  running = !running;
  updateStartBtn();
  if (running) {
    document.getElementById('info-status').textContent = 'è¿è¡Œä¸­';
    if (!startTime) startTime = null; // will be set on first frame
    frameTick = 0;
    animId = requestAnimationFrame(runLoop);
  } else {
    if (animId) cancelAnimationFrame(animId);
    document.getElementById('info-status').textContent = 'å·²æš‚åœ';
  }
}

function updateStartBtn() {
  const btn = document.getElementById('btn-start');
  if (running) { btn.textContent = 'â¸ æš‚åœ'; btn.classList.add('running'); }
  else { btn.textContent = 'â–¶ å¯åŠ¨'; btn.classList.remove('running'); }
}

function stepOnce() {
  if (converged) return;
  if (running) { running = false; updateStartBtn(); if (animId) cancelAnimationFrame(animId); }
  stepModel(); drawGrid();
  const stats = computeStats(); updateUI(stats); drawChart();
}

function resetModel() {
  running = false;
  if (animId) cancelAnimationFrame(animId);
  updateStartBtn();
  speedIdx = 0;
  document.getElementById('btn-speed').textContent = '1Ã—';
  document.getElementById('btn-speed').classList.remove('active');
  initModel(); drawGrid();
  const stats = computeStats(); updateUI(stats); drawChart();
  document.getElementById('info-status').textContent = 'å°±ç»ª';
}

// ====== SLIDER EVENTS ======
document.getElementById('slider-threshold').addEventListener('input', function() {
  document.getElementById('val-threshold').textContent = this.value + '%';
});
document.getElementById('slider-empty').addEventListener('input', function() {
  document.getElementById('val-empty').textContent = this.value + '%';
});

// ====== BOOT ======
window.addEventListener('resize', resize);
initModel(); resize();
const initStats = computeStats(); updateUI(initStats);
</script>
</body>
</html>
